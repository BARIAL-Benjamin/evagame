// @ts-nocheck
var extendStatics=function(t,e){return extendStatics=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(t,e){t.__proto__=e}||function(t,e){for(var i in e)Object.prototype.hasOwnProperty.call(e,i)&&(t[i]=e[i])},extendStatics(t,e)};function __extends(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Class extends value "+String(e)+" is not a constructor or null");function i(){this.constructor=t}extendStatics(t,e),t.prototype=null===e?Object.create(e):(i.prototype=e.prototype,new i)}var __assign=function(){return __assign=Object.assign||function(t){for(var e,i=1,n=arguments.length;i<n;i++)for(var s in e=arguments[i])Object.prototype.hasOwnProperty.call(e,s)&&(t[s]=e[s]);return t},__assign.apply(this,arguments)};function __spreadArray(t,e,i){if(i||2===arguments.length)for(var n,s=0,o=e.length;s<o;s++)!n&&s in e||(n||(n=Array.prototype.slice.call(e,0,s)),n[s]=e[s]);return t.concat(n||Array.prototype.slice.call(e))}"function"==typeof SuppressedError&&SuppressedError;var Bullet=function(){function t(t,e,i,n){this.id=Engine.createUID(),this.hitbox={width:10,height:10},this.speed=5,this.acceleration=0,this.sprite={url:"./sprites/bullet/Bullet.png",count:3,size:{width:64,height:16},currentSprite:0},this.health=1e3,this.direction=1,this.origin=t,this.position=e,this.vector=i,this.angle=n}return t.prototype.update=function(t){this.updateSprite(),Engine.displayEntity(t,this)},t.prototype.updateSprite=function(){this.sprite.currentSprite!==this.sprite.count-1&&(this.sprite.currentSprite=this.sprite.currentSprite+1)},t}(),Children=function(){function t(e){void 0===e&&(e={x:10,y:0});var i=this;this.id=Engine.createUID(),this.shootCountdown=1500,this.acceleration=.5,this.hitbox={width:10,height:10},this.sprite={url:"./sprites/eva/Eva01_run.png",count:23,size:{width:10,height:10},currentSprite:0},this.speed=0,this.health=200,this.direction=1,this.states=[],this.lastShootTime=0,this.jump=function(){if(!i.states.includes("jump")){i.states=i.setState("jump");var e=i.position.y,n=0,s=setInterval((function(){n<i.sprite.count?(i.sprite.currentSprite=n,i.position.y=e+t.jumpHeight*Math.sin(Math.PI/i.sprite.count*n),n++):(clearInterval(s),i.position.y=e,i.states=i.removeState("jump"))}),100)}},this.move=function(){i.position.x+=i.states.includes("crouch")?i.speed/2*i.direction:i.speed*i.direction,i.states=i.setState("run")},this.crouch=function(){i.sprite={url:"./sprites/eva/Eva01_crouch.png",count:1,currentSprite:0,size:{width:91,height:53}},i.hitbox={width:i.sprite.size.width,height:i.sprite.size.height},i.states=i.setState("crouch")},this.standUp=function(){i.sprite={url:"./sprites/eva/Eva01_run.png",count:1,currentSprite:0,size:{width:83,height:73}},i.states=[]},this.shoot=function(t){var e=Date.now();if(e-i.lastShootTime<i.shootCountdown)return null;i.lastShootTime=e;var n=Math.atan2(t.y-i.position.y,t.x-i.position.x),s={x:i.position.x+i.sprite.size.width,y:i.position.y+i.sprite.size.height},o={x:Math.cos(n)*i.speed,y:Math.sin(n)*i.speed};return new Bullet(i.id,s,o,n)},this.update=function(t){i.updateSprite(11,23),Engine.displayEntity(t,i)},this.position=e}return t.prototype.setState=function(t){var e=__spreadArray([],this.states,!0);return this.states.includes(t)&&(e=__spreadArray(__spreadArray([],this.states,!0),[t],!1)),e},t.prototype.removeState=function(t){var e=__spreadArray([],this.states,!0);return this.states.includes(t)&&(e=this.states.filter((function(e){return e!==t}))),e},t.prototype.updateSprite=function(t,e){t=null!=t?t:0,e=null!=e?e:this.sprite.count,this.states.includes("run")?this.sprite.currentSprite=t+(this.sprite.currentSprite-t+1)%(e-t):this.states.includes("crouch")&&(this.sprite.currentSprite=0)},t.maxSpeed=10,t.jumpHeight=100,t.maxHealth=200,t}(),Ange=function(){function t(t,e){var i=this;this.id=Engine.createUID(),this.acceleration=0,this.shootCountdown=1500,this.angle=0,this.lastShootTime=0,this.hitbox={width:10,height:10},this.health=150,this.sprite={url:"./sprites/ange/Ange.png",count:4,size:{width:10,height:10},currentSprite:0},this.direction=1,this.speed=5,this.shoot=function(t){var e=Date.now();if(e-i.lastShootTime<i.shootCountdown)return null;i.lastShootTime=e;var n=Math.atan2(t.y-i.position.y,t.x-i.position.x),s={x:i.position.x+i.sprite.size.width,y:i.position.y+i.sprite.size.height},o={x:Math.cos(n)*i.speed,y:Math.sin(n)*i.speed};return new Bullet(i.id,s,o,n)},this.update=function(t){i.updateSprite(),Engine.displayEntity(t,i)},this.updateSprite=function(){i.sprite.currentSprite=(i.sprite.currentSprite+1)%i.sprite.count},this.position=t,this.type=e}return t.prototype.move=function(){},t}(),GroundAnge=function(t){function e(e){return t.call(this,__assign(__assign({},e),{y:0}),"ground")||this}return __extends(e,t),e.prototype.move=function(){this.angle+=.05,this.position.x+=Math.cos(this.angle)*this.speed,this.position.y+=Math.sin(this.angle)*this.speed},e}(Ange),FlyingAnge=function(t){function e(e){var i=t.call(this,e,"flying")||this;return i.move=function(){return t.prototype.move.call(i)},i}return __extends(e,t),e}(Ange),Engine=function(){function t(e,i){var n,s,o,r,a,h;if(void 0===i&&(i={}),this.player=new Children,this.size=t.DEFAULT_SCREEN_SIZE,this.audioContext=new AudioContext,this.keyPressed={},this.engine=0,this.entities=((n={})[this.player.id]=this.player,n),this.clickableElements={},this.backgroundSound={url:"./sounds/backgrounds/main.mp3",loop:!0},!e)throw new Error("Impossible d'initialiser le jeu, canvas manquant");this.canvas=e;var c=this.canvas.getContext("2d");if(!c)throw new Error("Impossible d'initialiser le context");this.context=c,this.canvas.width=this.size.width,this.canvas.height=this.size.height,this.inputs=null!==(s=i.inputs)&&void 0!==s?s:t.DEFAULT_INPUTS,this.debug=null!==(o=i.debug)&&void 0!==o&&o,this.state=null!==(r=i.state)&&void 0!==r?r:"lobby",this.stage=null!==(a=i.stage)&&void 0!==a?a:0,this.tps=1e3/(null!==(h=i.tps)&&void 0!==h?h:20),this.canvas.addEventListener("click",this.handleCanvasClick.bind(this)),this.init()}return t.displayEntity=function(t,e){var i=new Image;i.src=e.sprite.url,i.onload=function(){t.clearRect(e.position.x,e.position.y,e.sprite.size.width,e.sprite.size.height),t.drawImage(i,e.sprite.currentSprite*e.sprite.size.width,0,e.sprite.size.width,e.sprite.size.height,e.position.x,e.position.y,e.sprite.size.width,e.sprite.size.width)}},t.createUID=function(){return"".concat(Date.now(),"-").concat(Math.floor(1e4*Math.random()))},t.prototype.init=function(){this.prepareEngine({width:"".concat(this.canvas.width,"px"),height:"".concat(this.canvas.height,"px"),backgroundPosition:"center",backgroundSize:"cover",backgroundRepeat:"no-repeat",backgroundImage:'url("./sprites/backgrounds/menu.webp")',imageRendering:"pixelated",border:"2px solid #000"}),this.statement()},t.prototype.resetEngine=function(){clearInterval(this.engine),this.engine=0},t.prototype.updateDOMEngine=function(t,e){void 0===e&&(e=this.canvas),Object.keys(t).forEach((function(i){"length"!==i&&"parentRule"!==i&&i in e.style?e.style[i]="".concat(t[i]):console.warn('La propriété "'.concat(i,"\" n'est pas valide"))}))},t.prototype.clearScreen=function(){for(var t=0,e=Object.values(this.clickableElements);t<e.length;t++){var i=e[t];this.clearElement(i)}},t.prototype.clearElement=function(t){console.log(this.clickableElements),this.context.clearRect(t.position.x,t.position.y,t.size.width,t.size.height),delete this.clickableElements[t.id]},t.prototype.statement=function(){switch(this.state){case"lobby":default:this.lobby();break;case"settings":this.settings();break;case"play":this.start();break;case"win":this.win();break;case"defeat":this.defeat()}},t.prototype.handleCanvasClick=function(t){for(var e=this.canvas.getBoundingClientRect(),i=t.clientX-e.left,n=t.clientY-e.top,s=0,o=Object.values(this.clickableElements);s<o.length;s++){var r=o[s];if(i>=r.position.x&&i<=r.position.x+r.size.width&&n>=r.position.y&&n<=r.position.y+r.size.height){r.action();break}}},t.prototype.lobby=function(){var t=this;this.prepareEngine({backgroundImage:'url("./sprites/backgrounds/menu.webp")'}),this.context.clearRect(0,0,this.size.width,this.size.height),this.playSound();var e=new Image;e.src="./sprites/logo.png",e.onload=function(){var i={width:e.width,height:e.height},n={x:t.canvas.width/2-i.width/2,y:t.canvas.height/2-i.height/2-100};t.drawImage(e,{x:0,y:0},i,n,i,(function(){t.stage=0,t.lobby()}));var s="Jouer",o={x:t.canvas.width/2-i.width/2-t.context.measureText(s).width/2,y:t.canvas.height/2-i.height/2};t.drawText(s,o,{actionOnClick:function(){t.stage=1,t.start()}})}},t.prototype.settings=function(){this.prepareEngine({backgroundImage:"url('./sprites/backgrounds/settings.webp')"})},t.prototype.prepareEngine=function(t){void 0===t&&(t={}),this.resetEngine(),this.clearScreen(),this.updateDOMEngine(t)},t.prototype.start=function(){var t=this;this.stage?(this.prepareEngine({backgroundImage:'url("./sprites/backgrounds/stage_'.concat(this.stage,'.webp")')}),this.engine=setInterval((function(){t.update()}),this.tps)):this.lobby()},t.prototype.win=function(){this.prepareEngine({backgroundImage:"url('./sprites/backgrounds/win.webp')"})},t.prototype.defeat=function(){this.prepareEngine({backgroundImage:"url('./sprites/backgrounds/defeat.webp')"})},t.prototype.checkCollision=function(t,e){return t.position.x<e.position.x+e.hitbox.width&&t.position.x+t.hitbox.width>e.position.x&&t.position.y<e.position.y+e.hitbox.height&&t.position.y+t.hitbox.height>e.position.y},t.prototype.destroyEntity=function(t){var e;null===(e=document.getElementById(t.id))||void 0===e||e.remove(),delete this.entities[t.id]},t.prototype.applyDamage=function(t,e){var i=t.health-e,n=!this.checkHealth(__assign(__assign({},t),{health:i}));return t.health=n?0:i,n},t.prototype.giveHealthToPlayer=function(t){var e=this.player.health+t;this.player.health=e>=Children.maxHealth?Children.maxHealth:e},t.prototype.giveHealthToEntity=function(t,e){t.health+=e},t.prototype.spawnEntity=function(t){var e;if("type"in t&&t.type)if("ground"===t.type)e=new GroundAnge(t.position);else{if("flying"!==t.type)throw new Error("Type d'ange non supporté : ".concat(t.type));e=new FlyingAnge(t.position)}else e="origin"in t&&t.origin?new Bullet(t.origin,t.position,t.vector,t.angle):new Children(t.position);this.entities[e.id]=e},t.prototype.checkInputsEntries=function(){var t=this;Object.keys(this.inputs).forEach((function(e){if(""===t.inputs[e])throw new Error("Impossible d'assigner une touche vide")}))},t.prototype.update=function(){var t=this;Object.keys(this.entities).forEach((function(e){t.entities[e].update(t.context)}))},t.prototype.checkHealth=function(t){return t.health>0},t.prototype.playSound=function(e){var i=this;void 0===e&&(e=this.backgroundSound);var n=function(){fetch(e.url).then((function(t){if(!t.ok)throw new Error("Impossible de récupérer le son");return t.arrayBuffer()})).then((function(t){return i.audioContext.decodeAudioData(t)})).then((function(t){var n=i.audioContext.createBufferSource();n.buffer=t,n.connect(i.audioContext.destination),n.start(),n.loop=e.loop})).catch((function(t){return console.error("Oups ! Un problème est survenue ! : ".concat(t))}))};if("suspended"===this.audioContext.state){var s=new Image;s.src="./sprites/sound-medium.png",s.onload=function(){var e={id:t.createUID(),position:{x:10,y:10},size:{width:s.width,height:s.height},action:function(){n(),i.clearElement(e)}};i.drawImage(s,{x:0,y:0},e.size,e.position,e.size,e.action)}}else n()},t.prototype.drawImage=function(e,i,n,s,o,r){void 0===r&&(r=t.NO_ACTION);var a=t.createUID();this.context.clearRect(s.x,s.y,n.width,n.height),this.context.drawImage(e,i.x,i.y,n.width,n.height,s.x,s.y,o.width,o.height),this.clickableElements[a]={id:a,position:{x:s.x,y:s.y},size:{width:n.width,height:n.height},action:r}},t.prototype.drawText=function(e,i,n){var s,o,r,a;void 0===n&&(n={fontName:"Jersey",fontSize:24,color:"#fff",actionOnClick:t.NO_ACTION});var h=null!==(s=n.fontSize)&&void 0!==s?s:24,c=t.createUID();this.context.font="".concat(h,"px ").concat(null!==(o=n.fontName)&&void 0!==o?o:"Jersey"),this.context.fillStyle=null!==(r=n.color)&&void 0!==r?r:"#fff",this.context.fillText(e,i.x,i.y),this.clickableElements[c]={id:c,position:{x:i.x,y:i.y},size:{width:this.context.measureText(e).width,height:h},action:null!==(a=n.actionOnClick)&&void 0!==a?a:t.NO_ACTION}},t.NO_ACTION=function(){},t.DEFAULT_INPUTS={jump:"z",left:"q",right:"f",crouch:"s",pause:"Escape"},t.DEFAULT_SCREEN_SIZE={width:720,height:540},t}();window.addEventListener("load",(function(){var t=document.querySelector("#evagame");if(!t)throw new Error("Impossible d'initialiser le jeu, canvas manquant");new Engine(t)}));