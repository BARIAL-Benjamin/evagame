var extendStatics=function(t,i){return(extendStatics=Object.setPrototypeOf||({__proto__:[]})instanceof Array&&function(t,i){t.__proto__=i}||function(t,i){for(var e in i)Object.prototype.hasOwnProperty.call(i,e)&&(t[e]=i[e])})(t,i)};function __extends(t,i){if("function"!=typeof i&&null!==i)throw TypeError("Class extends value "+String(i)+" is not a constructor or null");function e(){this.constructor=t}extendStatics(t,i),t.prototype=null===i?Object.create(i):(e.prototype=i.prototype,new e)}var __assign=function(){return(__assign=Object.assign||function t(i){for(var e,n=1,s=arguments.length;n<s;n++)for(var o in e=arguments[n])Object.prototype.hasOwnProperty.call(e,o)&&(i[o]=e[o]);return i}).apply(this,arguments)};function __awaiter(t,i,e,n){return new(e||(e=Promise))(function(s,o){function r(t){try{h(n.next(t))}catch(i){o(i)}}function a(t){try{h(n.throw(t))}catch(i){o(i)}}function h(t){var i;t.done?s(t.value):((i=t.value)instanceof e?i:new e(function(t){t(i)})).then(r,a)}h((n=n.apply(t,i||[])).next())})}function __generator(t,i){var e,n,s,o={label:0,sent:function(){if(1&s[0])throw s[1];return s[1]},trys:[],ops:[]},r=Object.create(("function"==typeof Iterator?Iterator:Object).prototype);return r.next=a(0),r.throw=a(1),r.return=a(2),"function"==typeof Symbol&&(r[Symbol.iterator]=function(){return this}),r;function a(a){return function(h){return function a(h){if(e)throw TypeError("Generator is already executing.");for(;r&&(r=0,h[0]&&(o=0)),o;)try{if(e=1,n&&(s=2&h[0]?n.return:h[0]?n.throw||((s=n.return)&&s.call(n),0):n.next)&&!(s=s.call(n,h[1])).done)return s;switch(n=0,s&&(h=[2&h[0],s.value]),h[0]){case 0:case 1:s=h;break;case 4:return o.label++,{value:h[1],done:!1};case 5:o.label++,n=h[1],h=[0];continue;case 7:h=o.ops.pop(),o.trys.pop();continue;default:if(!(s=(s=o.trys).length>0&&s[s.length-1])&&(6===h[0]||2===h[0])){o=0;continue}if(3===h[0]&&(!s||h[1]>s[0]&&h[1]<s[3])){o.label=h[1];break}if(6===h[0]&&o.label<s[1]){o.label=s[1],s=h;break}if(s&&o.label<s[2]){o.label=s[2],o.ops.push(h);break}s[2]&&o.ops.pop(),o.trys.pop();continue}h=i.call(t,o)}catch(c){h=[6,c],n=0}finally{e=s=0}if(5&h[0])throw h[1];return{value:h[0]?h[1]:void 0,done:!0}}([a,h])}}}function __spreadArray(t,i,e){if(e||2===arguments.length)for(var n,s=0,o=i.length;s<o;s++)!n&&s in i||(n||(n=Array.prototype.slice.call(i,0,s)),n[s]=i[s]);return t.concat(n||Array.prototype.slice.call(i))}"function"==typeof SuppressedError&&SuppressedError;var Bullet=function(){function t(t,i,e,n){this.id=Engine.createUID(),this.hitbox={width:10,height:10},this.speed=5,this.acceleration=0,this.sprite={url:"./sprites/bullet/Bullet.png",count:3,size:{width:64,height:16},currentSprite:0},this.health=1e3,this.direction=1,this.origin=t,this.position=i,this.vector=e,this.angle=n}return t.prototype.update=function(t){this.updateSprite(),Engine.displayEntity(t,this)},t.prototype.updateSprite=function(){this.sprite.currentSprite!==this.sprite.count-1&&(this.sprite.currentSprite=this.sprite.currentSprite+1)},t}(),Children=function(){function t(i){void 0===i&&(i={x:10,y:0});var e=this;this.id=Engine.createUID(),this.shootCountdown=1500,this.acceleration=.5,this.hitbox={width:10,height:10},this.sprite={url:"./sprites/eva/Eva01_run.png",count:23,size:{width:10,height:10},currentSprite:0},this.speed=0,this.health=200,this.direction=1,this.states=[],this.lastShootTime=0,this.jump=function(){if(!e.states.includes("jump")){e.states=e.setState("jump");var i=e.position.y,n=0,s=setInterval(function(){n<e.sprite.count?(e.sprite.currentSprite=n,e.position.y=i+t.jumpHeight*Math.sin(Math.PI/e.sprite.count*n),n++):(clearInterval(s),e.position.y=i,e.states=e.removeState("jump"))},100)}},this.move=function(){e.position.x+=e.states.includes("crouch")?e.speed/2*e.direction:e.speed*e.direction,e.states=e.setState("run")},this.crouch=function(){e.sprite={url:"./sprites/eva/Eva01_crouch.png",count:1,currentSprite:0,size:{width:91,height:53}},e.hitbox={width:e.sprite.size.width,height:e.sprite.size.height},e.states=e.setState("crouch")},this.standUp=function(){e.sprite={url:"./sprites/eva/Eva01_run.png",count:1,currentSprite:0,size:{width:83,height:73}},e.states=[]},this.shoot=function(t){var i=Date.now();if(i-e.lastShootTime<e.shootCountdown)return null;e.lastShootTime=i;var n=Math.atan2(t.y-e.position.y,t.x-e.position.x),s={x:e.position.x+e.sprite.size.width,y:e.position.y+e.sprite.size.height},o={x:Math.cos(n)*e.speed,y:Math.sin(n)*e.speed};return new Bullet(e.id,s,o,n)},this.update=function(t){e.updateSprite(11,23),Engine.displayEntity(t,e)},this.position=i}return t.prototype.setState=function(t){var i=__spreadArray([],this.states,!0);return this.states.includes(t)&&(i=__spreadArray(__spreadArray([],this.states,!0),[t],!1)),i},t.prototype.removeState=function(t){var i=__spreadArray([],this.states,!0);return this.states.includes(t)&&(i=this.states.filter(function(i){return i!==t})),i},t.prototype.updateSprite=function(t,i){t=null!=t?t:0,i=null!=i?i:this.sprite.count,this.states.includes("run")?this.sprite.currentSprite=t+(this.sprite.currentSprite-t+1)%(i-t):this.states.includes("crouch")&&(this.sprite.currentSprite=0)},t.maxSpeed=10,t.jumpHeight=100,t.maxHealth=200,t}(),Ange=function(){function t(t,i){var e=this;this.id=Engine.createUID(),this.acceleration=0,this.shootCountdown=1500,this.angle=0,this.lastShootTime=0,this.hitbox={width:10,height:10},this.health=150,this.sprite={url:"./sprites/ange/Ange.png",count:4,size:{width:10,height:10},currentSprite:0},this.direction=1,this.speed=5,this.shoot=function(t){var i=Date.now();if(i-e.lastShootTime<e.shootCountdown)return null;e.lastShootTime=i;var n=Math.atan2(t.y-e.position.y,t.x-e.position.x),s={x:e.position.x+e.sprite.size.width,y:e.position.y+e.sprite.size.height},o={x:Math.cos(n)*e.speed,y:Math.sin(n)*e.speed};return new Bullet(e.id,s,o,n)},this.update=function(t){e.updateSprite(),Engine.displayEntity(t,e)},this.updateSprite=function(){e.sprite.currentSprite=(e.sprite.currentSprite+1)%e.sprite.count},this.position=t,this.type=i}return t.prototype.move=function(){},t}(),GroundAnge=function(t){function i(i){return t.call(this,__assign(__assign({},i),{y:0}),"ground")||this}return __extends(i,t),i.prototype.move=function(){this.angle+=.05,this.position.x+=Math.cos(this.angle)*this.speed,this.position.y+=Math.sin(this.angle)*this.speed},i}(Ange),FlyingAnge=function(t){function i(i){var e=t.call(this,i,"flying")||this;return e.move=function(){return t.prototype.move.call(e)},e}return __extends(i,t),i}(Ange),Engine=function(){function t(i,e){void 0===e&&(e={});var n,s,o,r,a,h,c=this;if(this.player=new Children,this.size={width:Math.round(window.innerWidth/2),height:Math.round(window.innerHeight/2)},this.audioContext=new AudioContext,this.gain=this.audioContext.createGain(),this.keyPressed={},this.engine=0,this.entities=((n={})[this.player.id]={position:this.player.position,size:this.player.hitbox,update:this.player.update},n),this.clickableElements={},this.slidersElements={},this.isMuted=!1,this.lastTimeCheckPerformance=performance.now(),this.frameCount=0,this.fps=0,this.dragging=null,this.backgroundSound={url:"./sounds/backgrounds/main.mp3",loop:!0},this.drawFPS=function(){var t=performance.now();c.frameCount++,t-c.lastTimeCheckPerformance>=1e3&&(c.fps=c.frameCount,c.frameCount=0,c.lastTimeCheckPerformance=t);var i="FPS: ".concat(c.fps),e=c.context.measureText(i).width,n={x:c.canvas.width-e-50,y:32};c.context.clearRect(n.x-10,0,e+50,40),c.drawText(i,n),requestAnimationFrame(c.drawFPS)},!i)throw Error("Impossible d'initialiser le jeu, canvas manquant");this.canvas=i;var u=this.canvas.getContext("2d");if(!u)throw Error("Impossible d'initialiser le context");this.context=u,this.gain.connect(this.audioContext.destination),this.canvas.width=this.size.width,this.canvas.height=this.size.height,this.inputs=null!==(s=e.inputs)&&void 0!==s?s:t.DEFAULT_INPUTS,this.debug=null!==(o=e.debug)&&void 0!==o&&o,this.state=null!==(r=e.state)&&void 0!==r?r:"lobby",this.stage=null!==(a=e.stage)&&void 0!==a?a:0,this.tps=1e3/(null!==(h=e.tps)&&void 0!==h?h:20),this.canvas.addEventListener("click",this.handleCanvasClick.bind(this)),this.addEventListeners(),this.debug&&this.showDebug(),this.init()}return t.prototype.showDebug=function(){requestAnimationFrame(this.drawFPS)},t.displayEntity=function(t,i){var e=new Image;e.src=i.sprite.url,e.onload=function(){t.clearRect(i.position.x,i.position.y,i.sprite.size.width,i.sprite.size.height),t.drawImage(e,i.sprite.currentSprite*i.sprite.size.width,0,i.sprite.size.width,i.sprite.size.height,i.position.x,i.position.y,i.sprite.size.width,i.sprite.size.width)}},t.createUID=function(){return"".concat(Date.now(),"-").concat(Math.floor(Math.random()*Date.now()))},t.prototype.init=function(){this.loadCSS("/css/game.min.css"),this.prepareEngine({width:"".concat(this.canvas.width,"px"),height:"".concat(this.canvas.height,"px"),backgroundImage:'url("/sprites/backgrounds/main-large.png")'}),this.statement()},t.prototype.loadCSS=function(t){return __awaiter(this,void 0,void 0,function(){return __generator(this,function(i){switch(i.label){case 0:return[4,new Promise(function(i){var e=document.createElement("link");e.rel="stylesheet",e.type="text/css",e.href=t,document.head.appendChild(e)})];case 1:return i.sent(),[2]}})})},t.prototype.resetEngine=function(){clearInterval(this.engine),this.engine=0},t.prototype.updateDOMEngine=function(t,i){void 0===i&&(i=this.canvas),Object.keys(t).forEach(function(e){"length"!==e&&"parentRule"!==e&&e in i.style?i.style[e]="".concat(t[e]):console.warn('La propri\xe9t\xe9 "'.concat(e,"\" n'est pas valide"))})},t.prototype.clearScreen=function(){this.context.clearRect(0,0,this.canvas.width,this.canvas.height);for(var t=__assign(__assign({},this.clickableElements),this.slidersElements),i=0,e=Object.values(t);i<e.length;i++){var n=e[i];this.clearElement(n)}},t.prototype.clearElement=function(t){t.value?t.id in this.slidersElements&&(this.context.clearRect(t.position.x,t.position.y,t.size.width,t.radius&&t.radius>t.size.height?t.radius:t.size.height),delete this.slidersElements[t.id]):(this.context.clearRect(t.position.x,t.position.y,t.size.width,t.size.height),delete this.clickableElements[t.id])},t.prototype.statement=function(){switch(this.state){case"lobby":default:this.lobby();break;case"settings":this.settings();break;case"play":this.start();break;case"win":this.win();break;case"defeat":this.defeat()}},t.prototype.handleCanvasClick=function(t){for(var i=this.canvas.getBoundingClientRect(),e=t.clientX-i.left,n=t.clientY-i.top,s=0,o=Object.values(this.clickableElements);s<o.length;s++){var r=o[s];if(e>=r.position.x&&e<=r.position.x+r.size.width&&n>=r.position.y&&n<=r.position.y+r.size.height){r.action();break}}},t.prototype.lobby=function(){var t=this;this.prepareEngine({backgroundImage:'url("/sprites/backgrounds/main-large.png")'}),this.context.clearRect(0,0,this.canvas.width,this.canvas.height),this.playSound(this.backgroundSound);var i=new Image;i.src="/sprites/logo.png",i.onload=function(){var e={width:i.width,height:i.height},n={x:t.canvas.width/2-e.width/2,y:t.canvas.height/2-e.height/2-100};t.drawImage(i,{x:0,y:0},e,n,e,function(){t.stage=0,t.lobby()});var s="Jouer",o={x:t.canvas.width/2-e.width/2-t.context.measureText(s).width/2,y:t.canvas.height/2-e.height/2};t.drawText(s,o,{actionOnClick:function(){t.stage=1,t.start()}})}},t.prototype.settings=function(){this.prepareEngine({backgroundImage:"url('/sprites/backgrounds/settings.webp')"})},t.prototype.prepareEngine=function(t){void 0===t&&(t={}),this.resetEngine(),this.clearScreen(),this.updateDOMEngine(t)},t.prototype.start=function(){var t=this;this.stage?(this.prepareEngine({backgroundImage:'url("/sprites/backgrounds/stage_'.concat(this.stage,'.webp")')}),this.engine=setInterval(function(){t.update()},this.tps)):this.lobby()},t.prototype.win=function(){this.prepareEngine({backgroundImage:"url('/sprites/backgrounds/win.webp')"})},t.prototype.defeat=function(){this.prepareEngine({backgroundImage:"url('/sprites/backgrounds/defeat.webp')"})},t.prototype.checkCollision=function(t,i){return t.position.x<i.position.x+i.hitbox.width&&t.position.x+t.hitbox.width>i.position.x&&t.position.y<i.position.y+i.hitbox.height&&t.position.y+t.hitbox.height>i.position.y},t.prototype.destroyEntity=function(t){var i;null===(i=document.getElementById(t.id))||void 0===i||i.remove(),delete this.entities[t.id]},t.prototype.applyDamage=function(t,i){var e=t.health-i,n=!this.checkHealth(__assign(__assign({},t),{health:e}));return t.health=n?0:e,n},t.prototype.giveHealthToPlayer=function(t){var i=this.player.health+t;this.player.health=i>=Children.maxHealth?Children.maxHealth:i},t.prototype.giveHealthToEntity=function(t,i){t.health+=i},t.prototype.spawnEntity=function(t){var i;if("type"in t&&t.type){if("ground"===t.type)i=new GroundAnge(t.position);else if("flying"===t.type)i=new FlyingAnge(t.position);else throw Error("Type d'ange non support\xe9 : ".concat(t.type))}else i="origin"in t&&t.origin?new Bullet(t.origin,t.position,t.vector,t.angle):new Children(t.position);this.entities[i.id]={position:i.position,size:i.hitbox,update:i.update}},t.prototype.checkInputsEntries=function(){var t=this;Object.keys(this.inputs).forEach(function(i){if(""===t.inputs[i])throw Error("Impossible d'assigner une touche vide")})},t.prototype.update=function(){var t=this;Object.keys(this.entities).forEach(function(i){t.entities[i].update(t.context)})},t.prototype.checkHealth=function(t){return t.health>0},t.prototype.toggleSoundIcon=function(i,e){var n=this,s=new Image;s.src=e?"/sprites/soundOn-small.png":"/sprites/soundOff-small.png",s.onload=function(){var o={id:t.createUID(),position:{x:10,y:10},size:{width:s.width,height:s.height},action:function(){e?n.setAudioVolume(1):n.setAudioVolume(0),n.playAudio(i),n.clearElement(o),n.toggleSoundIcon(i,!e)}};n.drawImage(s,{x:0,y:0},o.size,o.position,o.size,o.action)}},t.prototype.playSound=function(t){var i=this;"suspended"===this.audioContext.state?(this.drawSlider({x:10,y:10},.5,{actionOnDrag:function(t){return i.setAudioVolume(t)}}),this.toggleSoundIcon(t,!1)):this.playAudio(t)},t.prototype.setAudioVolume=function(t){0<=t&&t<=1&&(this.gain.gain.value=t)},t.prototype.playAudio=function(t){var i=this;fetch(t.url).then(function(t){if(!t.ok)throw Error("Impossible de r\xe9cup\xe9rer le son");return t.arrayBuffer()}).then(function(t){return i.audioContext.decodeAudioData(t)}).then(function(e){var n=i.audioContext.createBufferSource();n.buffer=e,n.connect(i.gain),n.start(),n.loop=t.loop}).catch(function(t){return console.error("Oups ! Un probl\xe8me est survenu ! : ".concat(t))})},t.prototype.drawSlider=function(i,e,n){void 0===n&&(n={});var s,o,r,a,h,c,u,p,l=null!==(s=n.sliderColor)&&void 0!==s?s:"gray",d=null!==(r=null===(o=n.size)||void 0===o?void 0:o.height)&&void 0!==r?r:5,g=null!==(h=null===(a=n.size)||void 0===a?void 0:a.width)&&void 0!==h?h:200,f=null!==(c=n.cursorColor)&&void 0!==c?c:"blue",y=null!==(u=n.cursorRadius)&&void 0!==u?u:8;this.context.clearRect(i.x,i.y,g,d>y?d:y),this.context.fillStyle=l,this.context.fillRect(i.x,i.y,g,d);var $=i.x+e*g;this.context.beginPath(),this.context.arc($,i.y+d/2,y,0,2*Math.PI),this.context.fillStyle=f,this.context.fill();var v=t.createUID();this.slidersElements[v]={id:v,position:i,size:{width:g,height:d},sliderColor:l,cursorColor:f,radius:y,value:e,action:null!==(p=n.actionOnDrag)&&void 0!==p?p:t.NO_ACTION}},t.prototype.drawImage=function(i,e,n,s,o,r){void 0===r&&(r=t.NO_ACTION);var a=t.createUID();this.context.clearRect(s.x,s.y,n.width,n.height),this.context.drawImage(i,e.x,e.y,n.width,n.height,s.x,s.y,o.width,o.height),this.clickableElements[a]={id:a,position:{x:s.x,y:s.y},size:{width:n.width,height:n.height},action:r}},t.prototype.drawText=function(i,e,n){void 0===n&&(n={fontName:"Jersey",fontSize:24,color:"#fff",actionOnClick:t.NO_ACTION});var s,o,r,a,h=null!==(s=n.fontSize)&&void 0!==s?s:24,c=t.createUID();this.context.font="".concat(h,"px ").concat(null!==(o=n.fontName)&&void 0!==o?o:"Jersey"),this.context.fillStyle=null!==(r=n.color)&&void 0!==r?r:"#fff",this.context.fillText(i,e.x,e.y),this.clickableElements[c]={id:c,position:{x:e.x,y:e.y},size:{width:this.context.measureText(i).width,height:h},action:null!==(a=n.actionOnClick)&&void 0!==a?a:t.NO_ACTION}},t.prototype.addEventListeners=function(){var t=this;this.canvas.addEventListener("mousedown",function(i){for(var e=0,n=Object.values(t.slidersElements);e<n.length;e++){var s=n[e],o=s.position.x+s.value*s.size.width;Math.abs(i.offsetX-o)<s.radius&&Math.abs(i.offsetY-s.position.y)<s.radius&&(t.dragging=s)}}),this.canvas.addEventListener("mousemove",function(i){if(t.dragging){var e=Math.max(0,Math.min(1,(i.offsetX-t.dragging.position.x)/t.dragging.size.width));t.dragging.value=e,t.dragging.action(e),t.drawSlider(t.dragging.position,t.dragging.value)}}),this.canvas.addEventListener("mouseup",function(){t.dragging=null}),this.canvas.addEventListener("mouseleave",function(){t.dragging=null})},t.NO_ACTION=function(){},t.DEFAULT_INPUTS={jump:"z",left:"q",right:"f",crouch:"s",pause:"Escape"},t}();window.addEventListener("load",function(){var t=document.querySelector("#evagame");if(!t)throw Error("Impossible d'initialiser le jeu, canvas manquant");new Engine(t,{debug:!0})});